
/**
 * This ruleset enforces a public read-only security model for a city information application.
 *
 * Core Philosophy:
 * The data for parking, public transport, and micro-mobility is considered public information,
 * accessible to any user, including those who are not signed in. To ensure data integrity, all
 * write operations (create, update, delete) are disabled for client applications, except for
 * authenticated admin-like users.
 *
 * Data Structure:
 * Data is organized into logical, top-level collections for each major feature:
 * - /users/{userId}
 * - /parking_lots/{parkingLotId}
 * - /public_transport_routes/{routeId}
 * - /public_transport_stops/{stopId}
 * - /micro_mobility_vehicles/{vehicleId}
 *
 * Key Security Decisions:
 * - User Profiles: Users can create their own profile upon sign-up. They can only read and update their own
 *   profile, and cannot view other users' profiles.
 * - Public Read Access: All other collections are publicly readable (`get`, `list`)
 *   to provide real-time information to all app users without requiring authentication.
 * - Authenticated Writes: For management collections, write permissions
 *   (`create`, `update`, `delete`) are restricted to authenticated users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to create their own profile, and read/update their own data.
     * @path /users/{userId}
     */
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, update: if request.auth != null && request.auth.uid == userId;
      allow delete, list: if false;
    }

    /**
     * @description Provides public read access. Allows authenticated users to manage parking lots.
     * @path /parking_lots/{parkingLotId}
     */
    match /parking_lots/{parkingLotId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null;
    }

    /**
     * @description Provides public, read-only access to individual parking sensor data.
     * @path /parking_lots/{parkingLotId}/sensors/{sensorId}
     */
    match /parking_lots/{parkingLotId}/sensors/{sensorId} {
      allow read: if true;
      allow write: if false;
    }

    /**
     * @description Provides public read access. Allows authenticated users to manage transport routes.
     * @path /public_transport_routes/{routeId}
     */
    match /public_transport_routes/{routeId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null;

      /**
       * @description Provides public, read-only access to real-time updates for a specific route.
       * @path /public_transport_routes/{routeId}/real_time_updates/{updateId}
       */
      match /real_time_updates/{updateId} {
        allow read: if true;
        allow write: if false;
      }
    }

    /**
     * @description Provides public, read-only access to public transport stop information.
     * @path /public_transport_stops/{stopId}
     */
    match /public_transport_stops/{stopId} {
      allow read: if true;
      allow write: if false;
    }

    /**
     * @description Provides public read access. Allows authenticated users to manage micro-mobility vehicles.
     * @path /micro_mobility_vehicles/{vehicleId}
     */
    match /micro_mobility_vehicles/{vehicleId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null;
    }
  }
}
